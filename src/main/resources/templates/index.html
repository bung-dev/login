<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title>Index</title>
    <style>
        body { font-family: sans-serif; padding: 40px; }
        .btn { display:inline-block; padding:12px 16px; border:1px solid #ddd; border-radius:10px; text-decoration:none; cursor:pointer; background:#fff; }
        .row { display:flex; gap:12px; align-items:center; }
    </style>
</head>
<body>
<h1>login 프로젝트</h1>
<p>구글 소셜 로그인 테스트</p>

<!-- ✅ 로그인 안 된 경우: 로그인 버튼 -->
<div sec:authorize="isAnonymous()">
    <a class="btn" href="/oauth2/authorization/google">Google로 로그인</a>
</div>

<!-- ✅ 로그인 된 경우: 로그아웃 + reissue 버튼 -->
<div sec:authorize="isAuthenticated()">
    <div class="row">
    <span>
      로그인됨:
      <b sec:authentication="name"></b>
    </span>

        <!-- ✅ 추가: reissue 버튼 -->
        <button class="btn" type="button" onclick="reissue()">Access 재발급</button>

        <button class="btn" type="button" onclick="logout()">로그아웃</button>
    </div>
</div>

<script>
    async function reissue() {
      try {
        const res = await fetch("/reissue", {
          method: "POST",
          credentials: "same-origin" // refresh 쿠키 포함
        });

        if (res.ok) {
          alert("재발급 완료!");
          return;
        }

        // refresh 쿠키 없음/만료 등
        if (res.status === 401) {
          alert("재발급 실패: refresh 쿠키가 없거나 만료됨");
          return;
        }

        alert("재발급 실패");
      } catch (e) {
        alert("재발급 중 오류 발생");
      }
    }

    async function logout() {
      try {
        const res = await fetch("/logout", {
          method: "POST",
          credentials: "same-origin"
        });

        if (res.status === 204 || res.ok) {
          window.location.reload();
          return;
        }
        window.location.reload();
      } catch (e) {
        window.location.reload();
      }
    }
</script>

</body>
</html>